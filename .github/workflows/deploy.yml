name: Build & Deploy to Remote Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Backend
      - name: Checkout Backend
        uses: actions/checkout@v4
        with:
          repository: AiM-Club/AiM-server
          ref: main

      # 2. Checkout Frontend
      #- name: Checkout Frontend
       # uses: actions/checkout@v4
      # with:
        #  repository: AiM-Club/AiM-web
         # path: frontend
          # ref: main

      # 3. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 4. Cache npm dependencies
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            frontend/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 5. Build Frontend
      # - name: Build Frontend
        # working-directory: ./frontend
        # run: |
          # npm ci
         # npm run build

#      # 6. Copy frontend build to Spring Boot static
#      - name: Copy frontend build to Spring Boot static
#        run: |
#          rm -rf ./src/main/resources/static/*
#          mkdir -p ./src/main/resources/static
#          cp -r ./frontend/dist/* ./src/main/resources/static/

      # 7. Setup JDK
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin

      # 8. Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 9. Make Gradle executable
      - name: Make Gradle Executable
        run: chmod +x ./gradlew

      # 10. Build Spring Boot JAR
      - name: Build JAR
        run: ./gradlew bootJar
      # 빌드된 JAR 파일을 Docker 인식 하도록 함
      - name: Rename jar for Docker
        run: |
          cp build/libs/*.jar app.jar

      # 11. Docker Hub Login
      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      # 12. Build & Push Docker Image
      - name: Build & Push Docker Image
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_HUB_USERNAME }}/aim-server:latest
          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME

      # 13. Install sshpass
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # 14. Register SSH Host
      - name: Register SSH Host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 15. Prepare remote directories
      - name: Prepare Remote Directories
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            mkdir -p ${{ secrets.ENV_DEPLOY_PATH }}
          "

      # 16. Transfer JAR, Dockerfile, docker-compose
      - name: Transfer Files
        run: |
          DEPLOY_PATH=${{ secrets.ENV_DEPLOY_PATH }}
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -P ${{ secrets.SERVER_PORT }} build/libs/*.jar ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$DEPLOY_PATH/app.jar
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -P ${{ secrets.SERVER_PORT }} Dockerfile ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$DEPLOY_PATH/Dockerfile
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -P ${{ secrets.SERVER_PORT }} docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$DEPLOY_PATH/docker-compose.prod.yml

      # 17. Create .env.prod and transfer
      - name: Create .env.prod and Transfer
        run: |
          echo "DB_HOST=${{ secrets.ENV_DB_HOST }}" >> .env.prod
          echo "DB_NAME=${{ secrets.ENV_DB_NAME }}" >> .env.prod
          echo "DB_USERNAME=${{ secrets.ENV_DB_USERNAME }}" >> .env.prod
          echo "DB_PASSWORD=${{ secrets.ENV_DB_PASSWORD }}" >> .env.prod
          echo "DB_PORT=${{ secrets.ENV_DB_PORT }}" >> .env.prod
          echo "JWT_SECRET_KEY=${{ secrets.ENV_JWT_SECRET_KEY }}" >> .env.prod
          echo "GEMINI_API_KEY=${{ secrets.ENV_GEMINI_API_KEY }}" >> .env.prod
          echo "APP_CORS_ORIGINS=${{ secrets.FRONTEND_URL }}" >> .env.prod
          echo "TZ=Asia/Seoul" >> .env.prod
          DEPLOY_PATH=${{ secrets.ENV_DEPLOY_PATH }}
          echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env.prod
          echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> .env.prod
          echo "KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}" >> .env.prod
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env.prod
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env.prod
          echo "GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}" >> .env.prod
    

          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -P ${{ secrets.SERVER_PORT }} .env.prod ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$DEPLOY_PATH/.env.prod

      # 18. Deploy with Docker Compose
      - name: Remote Deploy
        run: |
          DEPLOY_PATH=${{ secrets.ENV_DEPLOY_PATH }}
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            cd $DEPLOY_PATH &&
            docker compose --env-file .env.prod -f docker-compose.prod.yml down &&
            docker compose --env-file .env.prod -f docker-compose.prod.yml up -d --build
          "
