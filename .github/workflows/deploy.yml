name: Build Backend with Remote Frontend and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # manual trigger
  repository_dispatch:
    types: [frontend-update]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1 Checkout Backend Repository
      - name: Checkout Backend Repository
        uses: actions/checkout@v4
        with:
          repository: AiM-Club/AiM-server
          ref: main

          # 2 Checkout Frontend Repository
      - name: Checkout Frontend Repository
        uses: actions/checkout@v4
        with:
          repository: AiM-Club/AiM-server
          path: frontend
          ref: develop

      # 3 Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 4 Cache npm dependencies
      - name: Cache npm dependencies
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: |
            ~/.npm
            frontend/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 5 Install & Build Frontend
      - name: Build Frontend
        working-directory: ./frontend
        continue-on-error: true
        run: |
          npm ci
          npm run build

      # 6 Copy frontend build to Spring Boot static
      - name: Copy frontend build to Spring Boot static
        continue-on-error: true
        run: |
          echo "Copying frontend build from $(pwd)/frontend/dist to $(pwd)/src/main/resources/static"
          rm -rf ./src/main/resources/static/*
          mkdir -p ./src/main/resources/static
          cp -r ./frontend/dist/* ./src/main/resources/static/

      # 7 Setup JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      # 8 Cache Gradle packages
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 9 Make Gradle executable
      - name: Make Gradle executable
        run: chmod +x ./gradlew

      # 10 Build Spring Boot JAR
      - name: Build JAR
        run: ./gradlew bootJar

      # 11⃣ Install sshpass
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # 122️ Register Remote SSH Host
      - name: Register SSH Host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 22 167.86.111.93 >> ~/.ssh/known_hosts

      # 13⃣ Prepare Directories on Remote
      - name: Prepare Remote Directories
        run: |
          sshpass -p "aimserver#01" ssh -p 22 aim@167.86.111.93 "
            mkdir -p /home/aim &&
            mkdir -p /home/aim/docker-compose
          "

      # 14 Transfer Files to Remote
      - name: Send app.jar and Dockerfile
        run: |
          sshpass -p "aimserver#01" scp -P 22 build/libs/*.jar aim@167.86.111.93:/home/aim/docker-compose/app.jar
          sshpass -p "aimserver#01" scp -P 22 Dockerfile aim@167.86.111.93:/home/aim/docker-compose/Dockerfile

      # 15 Create .env.prod (환경 변수 파일)
      - name: Create .env.prod
        run: |
          echo "DB_HOST=167.86.111.93" >> .env.prod
          echo "DB_NAME=aim_db" >> .env.prod
          echo "DB_USERNAME=aim" >> .env.prod
          echo "DB_PASSWORD=aimserver#01" >> .env.prod
          echo "DB_PORT=3306" >> .env.prod
          echo "JWT_SECRET_KEY=${{ secrets.ENV_JWT_SECRET_KEY }}" >> .env.prod
          echo "GEMINI_API_KEY=${{ secrets.ENV_GEMINI_API_KEY }}" >> .env.prod
          echo "TZ=Asia/Seoul" >> .env.prod

      # 16⃣ Transfer docker-compose.prod.yml and .env.prod
      - name: Send docker-compose.prod.yml and .env.prod
        run: |
          sshpass -p "aimserver#01" scp -P 22 docker-compose.prod.yml aim@167.86.111.93:/home/aim/docker-compose/docker-compose.prod.yml
          sshpass -p "aimserver#01" scp -P 22 .env.prod aim@167.86.111.93:/home/aim/docker-compose/.env.prod

      # 17 Deploy with Docker Compose on Remote Server
      - name: Remote Deploy with Docker Compose
        run: |
          sshpass -p "aimserver#01" ssh -p 22 aim@167.86.111.93 "
            cd /home/aim/docker-compose &&
            docker compose --env-file .env.prod -f docker-compose.prod.yml down &&
            docker compose --env-file .env.prod -f docker-compose.prod.yml up -d --build
          "
